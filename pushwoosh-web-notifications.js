!function(e){function t(n){if(r[n])return r[n].exports;var i=r[n]={exports:{},id:n,loaded:!1};return e[n].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){"use strict";function n(){var e,t=s.getGlobal(),r=t.Pushwoosh;r&&(e=r),r=new i.default,Array.isArray(e)&&e.forEach(function(e){return r.push(e)}),t.Pushwoosh=r}var i=r(4),s=r(1);"complete"===document.readyState?n():window.addEventListener("load",n)},function(e,t,r){"use strict";function n(){return Function("return this")()}function i(){return"3.0.8"}function s(){var e=n();return!!e.safari&&navigator.userAgent.indexOf("Safari")>-1}function o(){return navigator.serviceWorker&&"PushManager"in window}function a(){return s()?10:~navigator.userAgent.toLowerCase().indexOf("firefox")?12:11}function u(){var e=navigator.userAgent,t=e.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[],r=null;return/trident/i.test(t[1])?(r=/\brv[ :]+(\d+)/g.exec(e)||[],"IE "+(r[1]||"")):"Chrome"===t[1]&&(r=e.match(/\bOPR\/(\d+)/),null!==r)?"Opera "+r[1]:(t=t[2]?[t[1],t[2]]:[navigator.appName,navigator.appVersion,"-?"],r=e.match(/version\/([.\d]+)/i),null!==r&&t.splice(1,1,r[1]),t.join(" "))}function c(e){for(var t="=".repeat((4-e.length%4)%4),r=(e+t).replace(/-/g,"+").replace(/_/g,"/"),n=window.atob(r),i=new Uint8Array(n.length),s=0;n.length>s;++s)i[s]=n.charCodeAt(s);return i}function l(){var e=navigator.userAgent;return e.match(/Android/i)||e.match(/webOS/i)||e.match(/iPhone/i)||e.match(/iPad/i)||e.match(/iPod/i)||e.match(/BlackBerry/i)||e.match(/Windows Phone/i)?"Phone":"PC"}function h(e){for(var t="0123456789abcdef",r="",n=0;32>n;n++){var i=e.length-n-1,s=0;0>i||(s=e.charCodeAt(i)),r+=t.substr(s%t.length,1)}return r}function p(e,t){return t=f()||t||v(),e+"_"+h(t)}function f(){return localStorage.getItem(_.keyFakePushToken)}function v(){var e=d();return localStorage.setItem(_.keyFakePushToken,e),e}function d(e){e=e||32;for(var t="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=0;e>n;n++)t+=r.charAt(Math.floor(Math.random()*r.length));return t}function g(e){return e?e.subscriptionId?e.subscriptionId:12===a()?e.endpoint:e.endpoint.split("/").pop():""}function m(e,t){var r=e&&e.getKey&&e.getKey(t);return r?btoa(String.fromCharCode.apply(String,new Uint8Array(r))):""}function y(e){return m(e,"auth")}function b(e){return m(e,"p256dh")}function P(e,t,r){var n="cp";s()||!e||~e.indexOf(".")||(n=e+".api");var i="https://"+(r||""||n+".pushwoosh.com")+"/json/1.3/";return new Promise(function(e){t&&e(i),A.keyValue.get(_.keyApiBaseUrl).then(function(t){void 0===t&&(t=null),e(t||i)}).catch(function(){e(i)})})}function w(){for(var e,t=function(){},r=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeStamp","trace","warn"],i=r.length,s=n(),o=s.console=s.console||{};i--;)e=r[i],o[e]||(o[e]=t)}function k(){var e=n();"Promise"in e||(e.Promise=function(){return{then:function(){},catch:function(){}}})}function S(){var e=n();"history"in e&&history.pushState?history.pushState(null,"","#"):location.hash="#"}function O(e){return isNaN(e)?20:(e=Math.round(e),Math.min(60,0>e?20:e))}var A=r(3),_=r(2);t.getGlobal=n,t.getVersion=i,t.isSafariBrowser=s,t.canUseServiceWorkers=o,t.getBrowserType=a,t.getBrowserVersion=u,t.urlB64ToUint8Array=c,t.getDeviceName=l,t.createUUID=h,t.generateHwid=p,t.getFakePushToken=f,t.generateFakePushToken=v,t.getPushToken=g,t.getAuthToken=y,t.getPublicKey=b,t.getPushwooshUrl=P,t.patchConsole=w,t.patchPromise=k,t.clearLocationHash=S,t.prepareDuration=O},function(e,t){"use strict";t.defaultServiceWorkerUrl="pushwoosh-service-worker.js",t.periodSendAppOpen=36e5,t.periodGoalEvent=864e5,t.defaultNotificationTitle="Pushwoosh notification",t.defaultNotificationImage="https://cp.pushwoosh.com/img/logo-medium.png",t.defaultNotificationUrl="/",t.keyApiParams="API_PARAMS",t.keyInitParams="INIT_PARAMS",t.keySDKVersion="SDK_VERSION",t.keyWorkerVersion="WORKER_VERSION",t.keyLastSentAppOpen="LAST_SENT_APP_OPEN",t.keyLastOpenMessage="LAST_OPEN_MESSAGE",t.keyApiBaseUrl="API_BASE_URL",t.keyFakePushToken="fakePushToken",t.keyDeviceRegistrationStatus="deviceRegistrationStatus",t.keySafariPreviousPermission="safariPreviousPermission"},function(e,t){"use strict";function r(e){console.info("onversionchange",e)}function n(){return o||(o=new Promise(function(e,t){var n=indexedDB.open("PUSHWOOSH_SDK_STORE",6);n.onsuccess=function(t){var n=t.target.result;n.onversionchange=r,e(n)},n.onerror=function(){return t(n.error)},n.onupgradeneeded=function(e){var t=e.target.result;t.onversionchange=r,t.objectStoreNames.contains(c)||t.createObjectStore(c,{keyPath:"key"});var n={keyPath:"id",autoIncrement:!0},i={unique:!1};if(!t.objectStoreNames.contains(l)){var s=t.createObjectStore(l,n);s.createIndex("environment","environment",i),s.createIndex("date","date",i),s.createIndex("type","type",i)}if(!t.objectStoreNames.contains(h)){var o=t.createObjectStore(h,n);o.createIndex("date","date",i)}}})),o}function i(e){return n().then(function(t){return new Promise(function(r,n){return e(t,r,n)})})}function s(e){return{get:function(t){return i(function(r,n,i){var s=r.transaction(e).objectStore(e).get(t);s.onsuccess=function(){var e=s.result;n(e&&e.value)},s.onerror=function(){i(s.error)}})},getAll:function(){return i(function(t,r,n){var i={},s=t.transaction(e).objectStore(e).openCursor();s.onsuccess=function(e){var t=e.target.result;t?(i[t.key]=t.value.value,t.continue()):r(i)},s.onerror=function(){n(s.error)}})},set:function(t,r){return i(function(n,i,s){var o=n.transaction([e],"readwrite").objectStore(e).put({key:t,value:r});o.onsuccess=function(){i(t)},o.onerror=function(){s(o.error)}})}}}var o,a=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},u=this&&this.__assign||Object.assign||function(e){for(var t,r=1,n=arguments.length;n>r;r++){t=arguments[r];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e},c="keyValue",l="logs",h="messages",p=function(){function e(){}return e.prototype._add=function(e){var t=this;return i(function(r,n,i){var s=r.transaction([t.name],"readwrite").objectStore(t.name).add(e);s.onsuccess=function(){n(e)},s.onerror=function(){i(s.error)}}).then(function(e){return t.getAll().then(function(r){if(Array.isArray(r)){var n=r.map(function(e){return e.id}).sort(function(e,t){return e==t?0:t>e?1:-1});if(n.length>t.maxItems)return Promise.all(n.slice(t.maxItems).map(function(e){return t.delete(e)})).then(function(){return e})}return e})})},e.prototype.delete=function(e){var t=this;return i(function(r,n,i){var s=r.transaction([t.name],"readwrite").objectStore(t.name).delete(e);s.onsuccess=function(){n(s.result)},s.onerror=function(){i(s.error)}})},e.prototype.getAll=function(){var e=this;return i(function(t,r,n){var i=[],s=t.transaction(e.name).objectStore(e.name).openCursor();s.onsuccess=function(e){var t=e.target.result;t?(i.push(t.value),t.continue()):r(i)},s.onerror=function(){n(s.error)}})},e}();t.LogBase=p;var f=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name=l,t.maxItems=100,t.environment="undefined"!=typeof self&&self.registration?"worker":"browser",t}return a(t,e),t.prototype.add=function(e,t,r){var n={type:e,environment:this.environment,message:""+t,date:new Date};return t instanceof Error&&(n.stack=t.stack),r&&(n.additional=r),this._add(n)},t}(p);t.LogLog=f;var v=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name=h,t.maxItems=25,t}return a(t,e),t.prototype.add=function(e){return this._add(u({},e,{date:new Date}))},t}(p);t.LogMessage=v,t.keyValue=s(c),t.log=new f,t.message=new v},function(e,t,r){"use strict";var n=this&&this.__assign||Object.assign||function(e){for(var t,r=1,n=arguments.length;n>r;r++){t=arguments[r];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e},i=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(o,a)}u((n=n.apply(e,t||[])).next())})},s=this&&this.__generator||function(e,t){function r(e){return function(t){return n([e,t])}}function n(r){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,s&&(o=s[2&r[0]?"return":r[0]?"throw":"next"])&&!(o=o.call(s,r[1])).done)return o;switch(s=0,o&&(r=[0,o.value]),r[0]){case 0:case 1:o=r;break;case 4:return a.label++,{value:r[1],done:!1};case 5:a.label++,s=r[1],r=[0];continue;case 7:r=a.ops.pop(),a.trys.pop();continue;default:if(o=a.trys,!(o=o.length>0&&o[o.length-1])&&(6===r[0]||2===r[0])){a=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&o[3]>r[1])){a.label=r[1];break}if(6===r[0]&&o[1]>a.label){a.label=o[1],o=r;break}if(o&&o[2]>a.label){a.label=o[2],a.ops.push(r);break}o[2]&&a.ops.pop(),a.trys.pop();continue}r=t.call(e,a)}catch(e){r=[6,e],s=0}finally{i=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}var i,s,o,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return{next:r(0),throw:r(1),return:r(2)}},o=r(7),a=r(6),u=r(1),c=r(2),l=r(5),h=r(10),p=r(9),f=r(8),v=r(3);t.eventOnReady="onReady",t.eventOnSubscribe="onSubscribe",t.eventOnUnsubscribe="onUnsubscribe",t.eventOnRegister="onRegister",t.eventOnPermissionPrompt="onPermissionPrompt",t.eventOnPermissionDenied="onPermissionDenied",t.eventOnPermissionGranted="onPermissionGranted",t.eventOnSWInitError="onSWInitError",t.eventOnPushDelivery="onPushDelivery",t.eventOnNotificationClick="onNotificationClick",t.eventOnNotificationClose="onNotificationClose",u.patchPromise();var d=function(){function e(){var e=this;this._ee=new o.default,this.isSafari=u.isSafariBrowser(),this.ready=!1,this.debug={showLog:function(){return i(this,void 0,void 0,function(){var e;return s(this,function(t){switch(t.label){case 0:return[4,v.log.getAll()];case 1:return e=t.sent(),console.log(e),[2]}})})},showKeyValues:function(){return i(this,void 0,void 0,function(){var e;return s(this,function(t){switch(t.label){case 0:return[4,v.keyValue.getAll()];case 1:return e=t.sent(),console.log(e),[2]}})})},showMessages:function(){return i(this,void 0,void 0,function(){var e;return s(this,function(t){switch(t.label){case 0:return[4,v.message.getAll()];case 1:return e=t.sent(),e.forEach(function(e){return console.log(e)}),[2]}})})}},this._onPromises=(r={},r[t.eventOnPermissionDenied]=new Promise(function(r){return e._ee.once(t.eventOnPermissionDenied,r)}),r[t.eventOnPermissionPrompt]=new Promise(function(r){return e._ee.once(t.eventOnPermissionPrompt,r)}),r[t.eventOnPermissionGranted]=new Promise(function(r){return e._ee.once(t.eventOnPermissionGranted,r)}),r);var r}return e.prototype.onReadyHandler=function(e){var r=this;this.ready?e(this.api):this._ee.on(t.eventOnReady,function(t){return e(r.api,t)})},e.prototype.push=function(e){var r=this;if("function"==typeof e)this.onReadyHandler(e);else{if(!Array.isArray(e))throw Error("invalid command");var n=e[0],i=e[1];switch(n){case"init":this.shouldInit()&&this.init(i).catch(function(e){return l.default.info("Pushwoosh init failed",e)});break;case t.eventOnReady:this.onReadyHandler(i);break;case t.eventOnRegister:case t.eventOnSubscribe:case t.eventOnUnsubscribe:case t.eventOnSWInitError:case t.eventOnPushDelivery:case t.eventOnNotificationClick:case t.eventOnNotificationClose:this._ee.on(n,function(e){return i(r.api,e)});break;case t.eventOnPermissionDenied:case t.eventOnPermissionPrompt:case t.eventOnPermissionGranted:this._onPromises[n].then(function(){return i(r.api)});break;default:throw Error("unknown command")}}},e.prototype.shouldInit=function(){return!!(this.isSafari&&"PC"===u.getDeviceName()||u.canUseServiceWorkers())||(l.default.info("This browser does not support pushes"),!1)},e.prototype.init=function(e){return i(this,void 0,void 0,function(){var r,i,o,a,f,v,d,g,m,y,b=this;return s(this,function(s){switch(s.label){case 0:if(this._initParams=e,r=e.scope,i=e.applicationCode,o=e.logLevel,a=void 0===o?"error":o,f=e.pushwooshApiUrl,!i)throw Error("no application code");return[4,u.getPushwooshUrl(i,!1,f)];case 1:if(v=s.sent(),d=this.params=n({autoSubscribe:!0,pushwooshUrl:v},e,{deviceType:u.getBrowserType(),tags:n({Language:navigator.language||"en"},e.tags,{"Device Model":u.getBrowserVersion()}),driversSettings:{worker:n({serviceWorkerUrl:c.defaultServiceWorkerUrl},e.driversSettings&&e.driversSettings.worker)}}),l.default.setLevel(a),!u.canUseServiceWorkers())return[3,7];g=d.driversSettings.worker,this.driver=new h.default({eventEmitter:this._ee,scope:r,applicationCode:i,serviceWorkerUrl:g.serviceWorkerUrl,applicationServerPublicKey:g.applicationServerPublicKey}),s.label=2;case 2:return s.trys.push([2,5,,6]),this.driver&&this.driver.initWorker?[4,this.driver.initWorker()]:[3,4];case 3:s.sent(),s.label=4;case 4:return[3,6];case 5:return m=s.sent(),l.default.write("error",m,"driver initialization failed"),[3,6];case 6:return[3,8];case 7:if(!this.isSafari||!d.safariWebsitePushID)throw Error("can't initialize safari");this.driver=new p.default({eventEmitter:this._ee,applicationCode:i,pushwooshUrl:d.pushwooshUrl,pushwooshApiUrl:d.pushwooshApiUrl,webSitePushID:d.safariWebsitePushID}),this._ee.on(t.eventOnReady,function(){var e=/#P(.*)/,t=decodeURIComponent(document.location.hash);e.test(t)&&b.api.pushStat(e.exec(t)[1]).then(u.clearLocationHash)}),s.label=8;case 8:return s.trys.push([8,10,,11]),[4,this.defaultProcess()];case 9:return s.sent(),"serviceWorker"in navigator&&(navigator.serviceWorker.onmessage=this.onServiceWorkerMessage.bind(this)),[3,11];case 10:return y=s.sent(),l.default.write("error",y,"defaultProcess fail"),[3,11];case 11:return[2]}})})},e.prototype.onServiceWorkerMessage=function(e){var t=(e||{}).data,r=void 0===t?{}:t,n=r||{},i=n.type,s=void 0===i?"":i,o=n.payload,a=void 0===o?{}:o;this._ee.emit(s,a)},e.prototype.initApi=function(){return i(this,void 0,void 0,function(){var e,t,r,i,o;return s(this,function(s){switch(s.label){case 0:return[4,this.driver.getAPIParams()];case 1:return e=s.sent(),[4,v.keyValue.get(c.keyLastOpenMessage)];case 2:return t=s.sent()||{},r=this.params,i=n({},e,{deviceType:r.deviceType,deviceModel:r.tags["Device Model"],applicationCode:r.applicationCode,language:r.tags.Language,pushwooshApiUrl:r.pushwooshApiUrl}),r.userId&&(i.userId=r.userId),o=f.default(r.applicationCode,r.pushwooshApiUrl),this.api=new a.default(o,i,t),[2]}})})},e.prototype.subscribe=function(e){return i(this,void 0,void 0,function(){var t,r,n,i;return s(this,function(s){switch(s.label){case 0:t=(e||{}).registerLess,r=void 0!==t&&t,s.label=1;case 1:return s.trys.push([1,8,,9]),[4,this.driver.isSubscribed()];case 2:return n=s.sent(),[4,this.driver.askSubscribe(r)];case 3:return s.sent(),r?[3,5]:[4,this.registerDuringSubscribe()];case 4:s.sent(),s.label=5;case 5:return n?[3,7]:[4,this.onSubscribeEmitter()];case 6:s.sent(),s.label=7;case 7:return[3,9];case 8:return i=s.sent(),l.default.write("error",i,"subscribe fail"),[3,9];case 9:return[2]}})})},e.prototype.registerDuringSubscribe=function(){return i(this,void 0,void 0,function(){var e;return s(this,function(t){switch(t.label){case 0:return[4,this.driver.isSubscribed()];case 1:return e=t.sent(),[4,this.initApi()];case 2:return t.sent(),this.isSafari?[4,this.open()]:[3,4];case 3:t.sent(),t.label=4;case 4:return[4,this.register(e)];case 5:return t.sent(),[2]}})})},e.prototype.onSubscribeEmitter=function(){return i(this,void 0,void 0,function(){var e;return s(this,function(r){switch(r.label){case 0:return[4,this.driver.isSubscribed()];case 1:return e=r.sent(),e&&this._ee.emit(t.eventOnSubscribe),[2]}})})},e.prototype.unsubscribe=function(){return i(this,void 0,void 0,function(){var e;return s(this,function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),[4,this.driver.unsubscribe()];case 1:return r.sent(),[4,this.api.unregisterDevice()];case 2:return r.sent(),this._ee.emit(t.eventOnUnsubscribe),[3,4];case 3:return e=r.sent(),l.default.write("error",e,"Error occurred during the unsubscribe"),[3,4];case 4:return[2]}})})},e.prototype.isDeviceRegistered=function(){return"registered"===localStorage.getItem(c.keyDeviceRegistrationStatus)},e.prototype.isSubscribed=function(){var e=this.isSafari||this.isDeviceRegistered();return e&&this.driver.isSubscribed()||Promise.resolve(!1)},e.prototype.register=function(e){return i(this,void 0,void 0,function(){var r,i,o,a,l,h,p,f,d,g;return s(this,function(s){switch(s.label){case 0:if(!this.api)throw Error("API is not inited");return[4,v.keyValue.getAll()];case 1:return r=s.sent(),i=c.keySDKVersion,o=r[i],a=c.keyApiParams,l=r[a],h=c.keyInitParams,p=r[h],[4,this.driver.getAPIParams()];case 2:return f=s.sent(),d=this.params,g=!(u.getVersion()===o&&JSON.stringify(l)===JSON.stringify(f)&&JSON.stringify(p)===JSON.stringify(d)),g||e?[4,Promise.all([v.keyValue.set(c.keyApiParams,f),v.keyValue.set(c.keyInitParams,d),v.keyValue.set(c.keySDKVersion,u.getVersion()),this.api.registerDevice(),this.api.setTags(n({},d.tags)),this.api.registerUser()])]:[3,4];case 3:s.sent(),this._ee.emit(t.eventOnRegister),s.label=4;case 4:return[2]}})})},e.prototype.open=function(){return i(this,void 0,void 0,function(){var e,t,r,n,i;return s(this,function(s){switch(s.label){case 0:return[4,this.driver.getAPIParams()];case 1:return e=s.sent(),t=Date.now(),[4,v.keyValue.get(c.keyLastSentAppOpen)];case 2:return r=s.sent(),n=isNaN(r)?0:+r,[4,this.needForcedOpen()];case 3:return i=s.sent(),this.isSafari&&!e.hwid?[2,Promise.resolve()]:i||t-n>c.periodSendAppOpen?[4,Promise.all([v.keyValue.set(c.keyLastSentAppOpen,t||Date.now()),this.api.applicationOpen()])]:[3,5];case 4:s.sent(),s.label=5;case 5:return[2]}})})},e.prototype.needForcedOpen=function(){return i(this,void 0,void 0,function(){var e,t,r,n;return s(this,function(i){switch(i.label){case 0:return this.isSafari?[4,v.keyValue.get(c.keySafariPreviousPermission)]:[2,Promise.resolve(!1)];case 1:return e=i.sent(),[4,this.driver.getPermission()];case 2:return t=i.sent(),r=function(e,t){return"granted"!==e&&"granted"===t},[4,v.keyValue.set(c.keySafariPreviousPermission,t)];case 3:return i.sent(),n=r(this.permissionOnInit,t)||r(e,t),[2,Promise.resolve(n)]}})})},e.prototype.defaultProcess=function(){return i(this,void 0,void 0,function(){var e,r,n,i;return s(this,function(s){switch(s.label){case 0:return e=(this.params||{}).autoSubscribe,r=void 0===e||e,n=this,[4,this.driver.getPermission()];case 1:return n.permissionOnInit=s.sent(),[4,this.initApi()];case 2:switch(s.sent(),i=this.permissionOnInit){case"denied":return[3,3];case"prompt":return[3,6];case"granted":return[3,12]}return[3,15];case 3:return this._ee.emit(t.eventOnPermissionDenied),this.isSafari||!this.isDeviceRegistered()?[3,5]:[4,this.unsubscribe()];case 4:s.sent(),s.label=5;case 5:return[3,16];case 6:return this.isSafari||!this.isDeviceRegistered()?[3,8]:[4,this.unsubscribe()];case 7:s.sent(),s.label=8;case 8:return r?[4,this.subscribe({registerLess:!0})]:[3,10];case 9:return s.sent(),[3,11];case 10:this._ee.emit(t.eventOnPermissionPrompt),s.label=11;case 11:return[3,16];case 12:return this._ee.emit(t.eventOnPermissionGranted),this.isSafari||this.isDeviceRegistered()?[3,14]:[4,this.subscribe({registerLess:!0})];case 13:s.sent(),s.label=14;case 14:return[3,16];case 15:l.default.write("error",this.permissionOnInit,"unknown permission value"),s.label=16;case 16:return[4,this.initApi()];case 17:return s.sent(),[4,this.open()];case 18:return s.sent(),[4,this.register()];case 19:return s.sent(),this._ee.emit(t.eventOnReady),this.ready=!0,[2]}})})},e.prototype.getHWID=function(){return i(this,void 0,void 0,function(){var e;return s(this,function(t){switch(t.label){case 0:return[4,this.driver.getAPIParams()];case 1:return e=t.sent().hwid,[2,Promise.resolve(e)]}})})},e.prototype.getPushToken=function(){return i(this,void 0,void 0,function(){var e;return s(this,function(t){switch(t.label){case 0:return[4,this.driver.getAPIParams()];case 1:return e=t.sent().pushToken,[2,Promise.resolve(e)]}})})},e.prototype.getUserId=function(){return i(this,void 0,void 0,function(){var e;return s(this,function(t){return e=this.params||{},[2,Promise.resolve(e.userId)]})})},e.prototype.getParams=function(){return i(this,void 0,void 0,function(){var e,t;return s(this,function(r){return e=(this.api||{}).params,t=void 0===e?{}:e,[2,Promise.resolve(t)]})})},e}();Object.defineProperty(t,"__esModule",{value:!0}),t.default=d},function(e,t,r){"use strict";function n(e){var t=Error(e);throw c.write("error",t,"logAndThrowError"),t}function i(e,t){var r=Error(e);c.write("error",r,"logAndRejectError"),t(r)}var s=r(3),o=r(1),a={error:1,info:2,debug:3},u=3;o.patchConsole();var c={setLevel:function(e){a[e]||(e="error"),u=a[e]},write:function(e,t,r){return"error"===e?this.error(t):this.info(t),s.log.add(e,t,r)}};Object.keys(a).forEach(function(e){var t=a[e];c[e]=function(){for(var r=[],n=0;arguments.length>n;n++)r[n]=arguments[n];t>u||(console.info.apply(console,[e].concat(r)),console.trace("trace"))}}),t.logAndThrowError=n,t.logAndRejectError=i,Object.defineProperty(t,"__esModule",{value:!0}),t.default=c},function(e,t,r){"use strict";var n=this&&this.__assign||Object.assign||function(e){for(var t,r=1,n=arguments.length;n>r;r++){t=arguments[r];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e},i=r(2),s=r(1),o=function(){function e(e,t,r){this.doPushwooshApiMethod=e,this.params=t,this.lastOpenMessage=r,this.timezone=60*-(new Date).getTimezoneOffset()}return Object.defineProperty(e.prototype,"isSafari",{get:function(){return s.isSafariBrowser()},enumerable:!0,configurable:!0}),e.prototype.callAPI=function(e,t){var r=this.params||{},i=r.hwid,s=void 0===i?"":i,o=r.applicationCode,a=void 0===o?"":o,u=r.userId,c=void 0===u?"":u;if(this.isSafari&&!s)return Promise.resolve();var l=t&&t.userId,h={application:a,hwid:s,userId:l||c||s};return this.doPushwooshApiMethod(e,n({},t,h))},e.prototype.registerDevice=function(){var e=this,t=this.params;return!t.pushToken||this.isSafari?Promise.resolve():new Promise(function(r,n){e.callAPI("registerDevice",{push_token:t.pushToken,public_key:t.publicKey,auth_token:t.authToken,language:t.language,timezone:e.timezone,device_model:t.deviceModel,device_type:t.deviceType}).then(function(){localStorage.setItem(i.keyDeviceRegistrationStatus,"registered"),r()}).catch(n)})},e.prototype.unregisterDevice=function(){var e=this;return this.isSafari?Promise.resolve():new Promise(function(t,r){e.callAPI("unregisterDevice").then(function(){localStorage.setItem(i.keyDeviceRegistrationStatus,""),t()}).catch(r)})},e.prototype.registerUser=function(e){var t={timezone:this.timezone,device_type:this.params.deviceType,userId:this.params.userId};return e&&(t.userId=e),t.userId?this.callAPI("registerUser",t):Promise.resolve()},e.prototype.applicationOpen=function(){return this.callAPI("applicationOpen",{push_token:this.params.pushToken,device_type:this.params.deviceType,timezone:this.timezone})},e.prototype.setTags=function(e){return this.callAPI("setTags",{tags:e})},e.prototype.getTags=function(){return this.callAPI("getTags")},e.prototype.pushStat=function(e){return this.callAPI("pushStat",{hash:e})},e.prototype.messageDeliveryEvent=function(e){return this.callAPI("messageDeliveryEvent",{hash:e})},e.prototype.postEvent=function(e,t){var r=this.lastOpenMessage,i=new Date,s=i.getTime(),o=Math.floor(s/1e3),a=o-i.getTimezoneOffset()/60*3600;if(r.expiry>Date.now()){if(t.msgHash)return Promise.reject("attribute msgHash already defined");t=n({},t,{msgHash:r.messageHash})}return this.callAPI("postEvent",{device_type:this.params.deviceType,event:e,attributes:t,timestampUTC:o,timestampCurrent:a})},e}();Object.defineProperty(t,"__esModule",{value:!0}),t.default=o},function(e,t){"use strict";var r=function(){function e(){this._events={}}return e.prototype.emit=function(e,t){var r=this._events[e]&&this._events[e].slice();if(r&&r.length)for(var n=0;r.length>n;n++)r[n](t)},e.prototype.on=function(e,t){return this._events[e]||(this._events[e]=[]),this._events[e].push(t),this},e.prototype.once=function(e,t){var r=this,n=!1,i=function(s){if(!n)return n=!0,r.removeListener(e,i),t(s)};return this.on(e,i)},e.prototype.removeListener=function(e,t){var r=this._events[e];if(r){var n=r.indexOf(t);n>-1&&r.splice(n,1),1>r.length&&delete this._events[e]}},e}();Object.defineProperty(t,"__esModule",{value:!0}),t.default=r},function(e,t,r){"use strict";function n(e,t){return function(r,n){return new Promise(function(u,c){a.getPushwooshUrl(e,!1,t).then(function(e){try{var t=""+e+r,a={request:n},l=new XMLHttpRequest;l.open("POST",t,!0),l.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),l.onload=function(){if(200==l.status)try{var e=JSON.parse(l.responseText),t=(e||{}).base_url,a=void 0===t?null:t;a&&s.keyValue.set(o.keyApiBaseUrl,a),200==e.status_code?(i.default.write("apirequest",r+" call with arguments: "+JSON.stringify(n)+" to Pushwoosh has been successful. Result: "+JSON.stringify(e.response),"createDoApiXHR"),u(e.response)):(s.keyValue.set(o.keyApiBaseUrl,null),i.logAndRejectError("Error occurred during the "+r+" call to Pushwoosh: "+e.status_message,c))}catch(e){s.keyValue.set(o.keyApiBaseUrl,null),i.logAndRejectError("Error parse responce: "+e,c)}else s.keyValue.set(o.keyApiBaseUrl,null),i.logAndRejectError("Error occurred, status code: "+l.status,c)},l.onerror=function(e){i.logAndRejectError("Pushwoosh response to "+r+" call in not ok: "+e,c)},l.send(JSON.stringify(a))}catch(e){i.logAndRejectError("Exception while "+r+" the device: "+e,c)}})})}}var i=r(5),s=r(3),o=r(2),a=r(1);Object.defineProperty(t,"__esModule",{value:!0}),t.default=n},function(e,t,r){"use strict";var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(o,a)}u((n=n.apply(e,t||[])).next())})},i=this&&this.__generator||function(e,t){function r(e){return function(t){return n([e,t])}}function n(r){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,s&&(o=s[2&r[0]?"return":r[0]?"throw":"next"])&&!(o=o.call(s,r[1])).done)return o;switch(s=0,o&&(r=[0,o.value]),r[0]){case 0:case 1:o=r;break;case 4:return a.label++,{value:r[1],done:!1};case 5:a.label++,s=r[1],r=[0];continue;case 7:r=a.ops.pop(),a.trys.pop();continue;default:if(o=a.trys,!(o=o.length>0&&o[o.length-1])&&(6===r[0]||2===r[0])){a=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&o[3]>r[1])){a.label=r[1];break}if(6===r[0]&&o[1]>a.label){a.label=o[1],o=r;break}if(o&&o[2]>a.label){a.label=o[2],a.ops.push(r);break}o[2]&&a.ops.pop(),a.trys.pop();continue}r=t.call(e,a)}catch(e){r=[6,e],s=0}finally{i=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}var i,s,o,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return{next:r(0),throw:r(1),return:r(2)}},s=r(4),o=r(1),a=function(){function e(e){this.params=e}return e.prototype.getPermissionObject=function(){return safari.pushNotification.permission(this.params.webSitePushID)},e.prototype.getPermission=function(){return n(this,void 0,void 0,function(){var e;return i(this,function(t){return e=this.getPermissionObject().permission,[2,"default"===e?"prompt":e]})})},e.prototype.isSubscribed=function(){return n(this,void 0,void 0,function(){var e;return i(this,function(t){switch(t.label){case 0:return[4,this.getPermission()];case 1:return e=t.sent(),[2,"granted"===e]}})})},e.prototype.askSubscribe=function(){var e=this.params||{},t=e.eventEmitter,r=void 0===t?{emit:function(e){return e}}:t,n=e.applicationCode,i=void 0===n?"":n,a=e.webSitePushID,u=void 0===a?"":a,c=e.pushwooshApiUrl,l=void 0===c?"":c;return new Promise(function(e,t){o.getPushwooshUrl(i,!0,l).then(function(n){safari.pushNotification.requestPermission(n+"safari",u,{application:i},function(n){"granted"===n.permission?(r.emit(s.eventOnPermissionGranted),e(!0)):(r.emit(s.eventOnPermissionDenied),t(!1))})})})},e.prototype.unsubscribe=function(){return new Promise(function(e){return e(!0)})},e.prototype.getAPIParams=function(){return n(this,void 0,void 0,function(){var e,t,r,n;return i(this,function(i){return e=(this.getPermissionObject()||{}).deviceToken,t=void 0===e?"":e,r=t&&t.toLowerCase()||"",n=t&&t.toUpperCase()||"",[2,{hwid:r,pushToken:n}]})})},e}();Object.defineProperty(t,"__esModule",{value:!0}),t.default=a},function(e,t,r){"use strict";var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(o,a)}u((n=n.apply(e,t||[])).next())})},i=this&&this.__generator||function(e,t){function r(e){return function(t){return n([e,t])}}function n(r){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,s&&(o=s[2&r[0]?"return":r[0]?"throw":"next"])&&!(o=o.call(s,r[1])).done)return o;switch(s=0,o&&(r=[0,o.value]),r[0]){case 0:case 1:o=r;break;case 4:return a.label++,{value:r[1],done:!1};case 5:a.label++,s=r[1],r=[0];continue;case 7:r=a.ops.pop(),a.trys.pop();continue;default:if(o=a.trys,!(o=o.length>0&&o[o.length-1])&&(6===r[0]||2===r[0])){a=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&o[3]>r[1])){a.label=r[1];break}if(6===r[0]&&o[1]>a.label){a.label=o[1],o=r;break}if(o&&o[2]>a.label){a.label=o[2],a.ops.push(r);break}o[2]&&a.ops.pop(),a.trys.pop();continue}r=t.call(e,a)}catch(e){r=[6,e],s=0}finally{i=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}var i,s,o,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return{next:r(0),throw:r(1),return:r(2)}},s=r(1),o=r(4),a=r(2),u=r(3),c=function(){function e(e){this.params=e}return Object.defineProperty(e.prototype,"scope",{get:function(){var e=(this.params||{}).scope,t=void 0===e?"/":e;if("string"!=typeof t)throw Error("invalid scope value");return t.length>1&&("/"!==t.substr(0,1)&&(t="/"+t),"/"!==t.substr(t.length-1)&&(t+="/")),t},enumerable:!0,configurable:!0}),e.prototype.initWorker=function(){return n(this,void 0,void 0,function(){var e,t;return i(this,function(r){switch(r.label){case 0:return e=this.scope,[4,navigator.serviceWorker.getRegistration()];case 1:return t=r.sent(),t&&null!=t.installing?[3,3]:[4,navigator.serviceWorker.register(""+e+this.params.serviceWorkerUrl+"?version="+s.getVersion(),{scope:e})];case 2:r.sent(),r.label=3;case 3:return[2]}})})},e.prototype.getPermission=function(){return n(this,void 0,void 0,function(){return i(this,function(e){return[2,"default"===Notification.permission?"prompt":Notification.permission]})})},e.prototype.isSubscribed=function(){return n(this,void 0,void 0,function(){var e,t;return i(this,function(r){switch(r.label){case 0:return[4,navigator.serviceWorker.getRegistration()];case 1:return e=r.sent(),e?[4,e.pushManager.getSubscription()]:[2,!1];case 2:return t=r.sent(),[2,!!t]}})})},e.prototype.emit=function(e){var t=(this.params||{}).eventEmitter,r=void 0===t?{emit:function(e){return e}}:t;r.emit(e)},e.prototype.askSubscribe=function(e){return n(this,void 0,void 0,function(){var t,r,n,a,u;return i(this,function(i){switch(i.label){case 0:return[4,navigator.serviceWorker.ready];case 1:return t=i.sent(),[4,t.pushManager.getSubscription()];case 2:if(r=i.sent(),n={userVisibleOnly:!0},11==s.getBrowserType()&&this.params.applicationServerPublicKey&&(n.applicationServerKey=s.urlB64ToUint8Array(this.params.applicationServerPublicKey)),r)return[3,7];i.label=3;case 3:return i.trys.push([3,5,,6]),[4,t.pushManager.subscribe(n)];case 4:return r=i.sent(),this.emit(o.eventOnPermissionGranted),[3,6];case 5:return a=i.sent(),
this.emit(o.eventOnPermissionDenied),[3,6];case 6:return[3,14];case 7:return e&&r.unsubscribe?[4,r.unsubscribe()]:[3,13];case 8:i.sent(),i.label=9;case 9:return i.trys.push([9,11,,12]),[4,t.pushManager.subscribe(n)];case 10:return r=i.sent(),this.emit(o.eventOnPermissionGranted),[3,12];case 11:return u=i.sent(),this.emit(o.eventOnPermissionDenied),[3,12];case 12:return[3,14];case 13:this.emit(o.eventOnPermissionGranted),i.label=14;case 14:return[2,r]}})})},e.prototype.unsubscribe=function(){return n(this,void 0,void 0,function(){var e,t;return i(this,function(r){switch(r.label){case 0:return[4,navigator.serviceWorker.getRegistration()];case 1:return e=r.sent(),e?[4,e.pushManager.getSubscription()]:[2,Promise.resolve()];case 2:return t=r.sent(),t&&t.unsubscribe?[2,t.unsubscribe()]:[2,Promise.resolve(!1)]}})})},e.prototype.getAPIParams=function(){return n(this,void 0,void 0,function(){var e,t,r,n,c;return i(this,function(i){switch(i.label){case 0:return[4,navigator.serviceWorker.getRegistration()];case 1:return(e=i.sent())?[3,3]:(t=a.keyApiParams,[4,u.keyValue.getAll()]);case 2:if(r=i.sent()[t],r&&"/"!==this.scope)return[2,r];throw this.emit(o.eventOnSWInitError),Error("No service worker registration");case 3:return[4,navigator.serviceWorker.ready];case 4:return e=i.sent(),[4,e.pushManager.getSubscription()];case 5:return n=i.sent(),c=s.getPushToken(n),[2,{hwid:s.generateHwid(this.params.applicationCode,c),pushToken:c,publicKey:s.getPublicKey(n),authToken:s.getAuthToken(n)}]}})})},e}();Object.defineProperty(t,"__esModule",{value:!0}),t.default=c}]);
//# sourceMappingURL=pushwoosh-web-notifications.js.map
